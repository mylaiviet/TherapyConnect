# Matomo Analytics Implementation Guide

## Overview

This guide explains how to identify and track **unique visitors** (anonymous users) versus **unique users** (authenticated users) using Matomo analytics in your TherapyConnect application.

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [Two-Tiered Tracking System](#two-tiered-tracking-system)
3. [Setup Instructions](#setup-instructions)
4. [Understanding the Metrics](#understanding-the-metrics)
5. [HIPAA Compliance](#hipaa-compliance)
6. [Testing the Implementation](#testing-the-implementation)
7. [Viewing Analytics in Matomo](#viewing-analytics-in-matomo)

---

## Architecture Overview

The implementation uses **two separate tracking systems**:

### 1. Anonymous Visitor Tracking (Client-Side)
- **Purpose**: Track users browsing the site before they log in or sign up
- **Technology**: Matomo JavaScript tracking (client-side)
- **Site ID**: 1 (configured as `VITE_MATOMO_SITE_ID`)
- **Identification**: Cookie-based visitor ID (automatically generated by Matomo)

### 2. Authenticated User Tracking (Server-Side)
- **Purpose**: Track registered users after login/signup
- **Technology**: Matomo HTTP API (server-side)
- **Site ID**: 2 (configured as `MATOMO_SITE_ID`)
- **Identification**: User ID from database (anonymized hash for visitor ID)

---

## Two-Tiered Tracking System

### Visitor Journey Flow

```
1. Anonymous Visitor
   ↓
   [Browsing site without login]
   ↓
   Tracked as "Unique Visitor" (Site ID: 1)
   - Cookie-based identification
   - No user_id set

2. User Signs Up / Logs In
   ↓
   [Authentication successful]
   ↓
   User ID is set in Matomo via setUserId()
   ↓
   Matomo links previous anonymous visitor to this user ID

3. Authenticated User
   ↓
   Tracked as "Unique User" (Site ID: 2)
   - Server-side tracking with user_id
   - All actions tracked with user context
```

### How Matomo Links Anonymous → Authenticated

When a user logs in or signs up:
1. Client-side calls `setUserId(userId)`
2. Matomo automatically links the previous anonymous visitor session to this user ID
3. Going forward, all tracking includes the user ID
4. Historical data from anonymous browsing is now associated with the authenticated user

---

## Setup Instructions

### Step 1: Install Matomo Self-Hosted

You need a self-hosted Matomo instance for HIPAA compliance. Follow the official Matomo installation guide:

**Server Requirements:**
- Linux server (Ubuntu/Debian recommended)
- PHP 7.4+ (8.0+ recommended)
- MySQL 5.7+ or MariaDB 10.3+
- Apache or Nginx
- SSL/TLS certificate (required for HIPAA)

**Installation Steps:**
1. Download Matomo from https://matomo.org/download/
2. Set up subdomain: `analytics.yourdomain.com`
3. Configure SSL certificate (use Let's Encrypt)
4. Run Matomo web installer
5. Create two websites in Matomo:
   - Site ID 1: "TherapyConnect - Anonymous Visitors"
   - Site ID 2: "TherapyConnect - Authenticated Users"

### Step 2: Configure Matomo for HIPAA Compliance

**In Matomo Settings:**

1. **Anonymize IP Addresses**
   - Go to: Administration → Privacy → Anonymize Visitors' Data
   - Set IP anonymization to: Mask 2 bytes (or more)
   - Save settings

2. **Disable User ID in Reports** (for privacy)
   - Go to: Administration → Privacy → Users Opt-Out
   - Enable privacy features

3. **Set Data Retention Policy**
   - Go to: Administration → Privacy → Delete Old Logs
   - Set retention: 90-180 days (per your privacy policy)
   - Enable automatic deletion

4. **Create Authentication Token**
   - Go to: Administration → Personal → Security
   - Click "Create new token"
   - Give it a description: "TherapyConnect Server API"
   - Copy the token (you'll need this for `MATOMO_AUTH_TOKEN`)

5. **Configure Custom Dimensions** (Optional)
   - Go to: Administration → Custom Dimensions
   - Create dimensions:
     - Dimension 1: "User Role" (Scope: Visit)
     - Dimension 2: "Account Age" (Scope: Visit)
     - Dimension 3: "Session Type" (Scope: Action)

### Step 3: Configure Environment Variables

Add the following to your `.env` file:

```bash
# Matomo Analytics Configuration

# Anonymous visitor tracking (client-side)
VITE_MATOMO_URL=https://analytics.yourdomain.com
VITE_MATOMO_SITE_ID=1

# Authenticated user tracking (server-side)
MATOMO_URL=https://analytics.yourdomain.com
MATOMO_SITE_ID=2
MATOMO_AUTH_TOKEN=your_auth_token_from_matomo_here
```

**Important Notes:**
- `VITE_` prefix is required for Vite to expose the variable to client-side code
- The two site IDs must be different (1 for anonymous, 2 for authenticated)
- Never commit your `.env` file with real values to version control

### Step 4: Install Required Dependencies

The implementation requires `axios` for server-side API calls:

```bash
npm install axios
```

### Step 5: Verify Installation

1. **Check client-side tracking:**
   - Open your app in a browser
   - Open browser DevTools → Network tab
   - Look for requests to `matomo.php` or `matomo.js`
   - You should see tracking requests being sent

2. **Check server-side tracking:**
   - Look at server logs after login/signup
   - You should see: `[Matomo Server] Event tracked: Authentication/Login`

3. **Check Matomo Dashboard:**
   - Log into your Matomo instance
   - Go to Dashboard
   - Verify visitors are being tracked

---

## Understanding the Metrics

### In Matomo Dashboard

#### Site 1: Anonymous Visitors
- **Unique Visitors**: Total count of unique anonymous users who browsed your site
- **Visits**: Number of sessions (30-minute timeout)
- **Page Views**: Total pages viewed by anonymous visitors
- **Bounce Rate**: % who left after viewing one page

**Common Metrics to Track:**
- Landing pages (which pages do visitors enter on?)
- Conversion rate (visitor → registered user)
- Time to conversion (how long before they sign up?)
- Exit pages (where do they leave?)

#### Site 2: Authenticated Users
- **Unique Users**: Total count of registered users who logged in
- **Events**: Custom actions tracked (searches, matches viewed, appointments booked)
- **User Engagement**: How many times users return, session length
- **Conversion Funnel**: Profile completion → Search → Match → Appointment

**Common Metrics to Track:**
- Profile completion rate
- Average matches viewed per user
- Appointment booking rate
- Return user rate (7-day, 30-day)
- Feature usage (which features are most used?)

### Key Performance Indicators (KPIs)

1. **Visitor-to-User Conversion Rate**
   ```
   Conversion Rate = (New Users / Unique Visitors) × 100
   ```

2. **User Activation Rate**
   ```
   Activation Rate = (Users with Complete Profile / Total Users) × 100
   ```

3. **Engagement Rate**
   ```
   Engagement Rate = (Users Who Perform Search / Total Users) × 100
   ```

4. **Appointment Booking Rate**
   ```
   Booking Rate = (Users Who Book Appointment / Users Who View Matches) × 100
   ```

### Creating Custom Reports

In Matomo, you can create custom reports to answer specific questions:

**Example: "How many anonymous visitors converted to users this week?"**
1. Go to Site 1 (Anonymous Visitors)
2. Note the "Unique Visitors" count for the week
3. Go to Site 2 (Authenticated Users)
4. Filter events by: Category="Authentication", Action="Login"
5. Count unique user IDs
6. Calculate: (Authenticated Users / Unique Visitors) × 100

**Example: "What's the average time from first visit to signup?"**
1. Enable User ID tracking in Matomo
2. Use the User Log feature to see individual user journeys
3. Look at timestamp of first visit vs. first "Registration" event

---

## HIPAA Compliance

### What is Tracked (HIPAA-Safe)

✅ **Anonymous data:**
- Page URLs (sanitized, no patient names)
- User actions (generic: "search performed", "match viewed")
- Session duration
- Device type, browser, screen resolution
- Anonymized IP address (last 2 octets removed)
- User ID (UUID, not linked to PHI)

✅ **Aggregated metrics:**
- Total visitors, total users
- Conversion rates
- Feature usage statistics
- Geographic data (city-level only)

### What is NOT Tracked (PHI)

❌ **Protected Health Information (PHI):**
- Patient names, emails, phone numbers
- Symptoms, diagnoses, conditions
- Insurance policy numbers
- Appointment details (date, time, therapist name)
- Message content
- Search queries containing health conditions

### PHI Protection Measures

The implementation includes automatic PHI sanitization:

**Client-Side (`analytics.ts`):**
- Sanitizes page titles to remove emails, phone numbers
- Strips PHI from event names and values
- Excludes query parameters that might contain PHI

**Server-Side (`matomoAnalytics.ts`):**
- Sanitizes all strings before sending to Matomo
- Removes emails, phone numbers, SSN patterns
- Never tracks appointment content or message text
- Uses generic event names (e.g., "Appointment Booked" vs. "Appointment with Dr. Smith")

**Configuration:**
- IP anonymization enabled
- Geographic precision limited to city-level
- No cross-site tracking
- No third-party cookies

### Audit Logging

All analytics tracking includes console logging for audit trails:
```
[Matomo] Anonymous visitor tracking initialized
[Matomo] User ID set: abc-123-def-456
[Matomo Server] Event tracked: Authentication/Login for user abc-123-def-456
```

---

## Testing the Implementation

### Test Scenario 1: Anonymous Visitor Tracking

1. **Open your app in incognito/private window**
2. **Browse a few pages** (home, therapist search, about)
3. **Check browser DevTools → Network tab**
   - Look for requests to `matomo.php`
   - Verify they contain `idsite=1` (anonymous site)
4. **Check Matomo Dashboard**
   - Go to Site 1 (Anonymous Visitors)
   - You should see 1 new visitor
   - Check Real-time → Visitor Log to see the visit

### Test Scenario 2: User Registration Tracking

1. **Continue in same incognito window**
2. **Sign up for a new account**
3. **Check browser console**
   - Should see: `[Matomo] User ID set: [your-user-id]`
4. **Check Matomo Dashboard**
   - Go to Site 2 (Authenticated Users)
   - Check Events → Category "User", Action "Registration"
   - Verify the event was tracked

### Test Scenario 3: Visitor-to-User Linking

1. **Open app in incognito window**
2. **Browse 2-3 pages** (track as anonymous visitor)
3. **Log in with existing account**
4. **Browse 2-3 more pages** (now tracked as authenticated user)
5. **Check Matomo Dashboard**
   - Go to Site 2 → Visitors → User Log
   - Find your user ID
   - You should see both:
     - Previous anonymous visits (before login)
     - Current authenticated visits (after login)

### Test Scenario 4: Event Tracking

1. **Log in to your app**
2. **Perform a therapist search**
3. **View therapist matches**
4. **Check server logs**
   - Should see: `[Matomo Server] Event tracked: Search/Performed`
5. **Check Matomo Dashboard**
   - Go to Site 2 → Behaviour → Events
   - Verify your search event appears

### Debugging Tips

**If tracking isn't working:**

1. **Check environment variables:**
   ```bash
   echo $VITE_MATOMO_URL
   echo $VITE_MATOMO_SITE_ID
   ```

2. **Check browser console for errors**
   - Open DevTools → Console
   - Look for Matomo-related errors

3. **Verify Matomo is accessible**
   - Open your browser
   - Go to: `https://analytics.yourdomain.com/matomo.php`
   - Should return: `GIF89a` (1x1 tracking pixel)

4. **Check server logs**
   ```bash
   grep "Matomo" server.log
   ```

5. **Test Matomo API directly**
   ```bash
   curl "https://analytics.yourdomain.com/matomo.php?idsite=2&rec=1&action_name=test&token_auth=YOUR_TOKEN"
   ```

---

## Viewing Analytics in Matomo

### Dashboard Setup

**Site 1: Anonymous Visitors Dashboard**

Recommended widgets:
1. Visitors Overview (visitors, visits, page views)
2. Visitor Log (real-time visitor activity)
3. Entry Pages (where visitors land)
4. Exit Pages (where visitors leave)
5. Referrers (how they found you)
6. Visitor Map (geographic distribution)

**Site 2: Authenticated Users Dashboard**

Recommended widgets:
1. Users Overview (total users, active users)
2. Events by Category (feature usage)
3. Custom Reports (conversion funnels)
4. User Flow (navigation patterns)
5. Returning Visitors (engagement over time)

### Creating Custom Segments

**Segment: "New Users This Week"**
```
User ID is set
AND
First visit date >= 7 days ago
```

**Segment: "Active Users" (logged in within 7 days)**
```
User ID is set
AND
Last visit date <= 7 days ago
```

**Segment: "Converted Visitors" (signed up after browsing)**
```
Has performed Event: Category=User, Action=Registration
```

### Setting Up Goals

Goals help you track conversions. Create these goals in Matomo:

**Goal 1: User Registration**
- Type: Event
- Category: "User"
- Action: "Registration"

**Goal 2: Profile Completion**
- Type: Event
- Category: "Profile"
- Action: "Completed"

**Goal 3: Appointment Booked**
- Type: Event
- Category: "Appointment"
- Action: "Booked"

**Goal 4: Match Viewed**
- Type: Event
- Category: "Matching"
- Action: "Results Viewed"

### Generating Reports

**Weekly Executive Summary:**
1. Go to: Dashboard → Email Reports
2. Create new report: "Weekly Summary"
3. Include:
   - Unique Visitors (Site 1)
   - New Users (Site 2, Registration events)
   - Conversion Rate (calculated)
   - Top Landing Pages
   - Goal Completions
4. Schedule: Every Monday at 9am

**Monthly Analytics Report:**
1. Go to: Dashboard → Scheduled Reports
2. Create report with:
   - Month-over-month growth
   - User retention (7-day, 30-day)
   - Feature usage statistics
   - Conversion funnel metrics

---

## Advanced Features

### Custom Event Tracking Examples

**Track therapist profile views:**
```typescript
// In your therapist profile component
import { trackEvent } from '@/services/analytics';

trackEvent('Profile', 'View', therapistId);
```

**Track search filters used:**
```typescript
// After user performs search
const filterCount = Object.keys(filters).length;
const resultsCount = therapists.length;

trackEvent('Search', 'Performed', `${filterCount} filters`, resultsCount);
```

**Track chatbot interactions:**
```typescript
// When user sends a message to chatbot
trackEvent('Chatbot', 'Message Sent', messageType);
```

### A/B Testing with Matomo

You can use Matomo for A/B testing:

1. **Install Matomo A/B Testing plugin**
2. **Create experiment in Matomo:**
   - Variation A: Current landing page
   - Variation B: New landing page design
3. **Track conversion:** User registration
4. **Run for 2 weeks**
5. **Analyze results** in Matomo dashboard

### Cohort Analysis

Track user cohorts over time:

1. **Define cohorts by signup date:**
   - Week 1 users
   - Week 2 users
   - Week 3 users

2. **Track retention:**
   - How many Week 1 users returned in Week 2?
   - How many are still active in Week 4?

3. **Compare engagement:**
   - Which cohort books more appointments?
   - Which features do different cohorts use?

---

## Maintenance & Best Practices

### Regular Tasks

**Weekly:**
- Review real-time dashboard for anomalies
- Check for tracking errors in server logs
- Verify data is being collected correctly

**Monthly:**
- Review data retention policy (delete old logs per HIPAA)
- Update custom dimensions if needed
- Review and optimize slow-loading analytics calls

**Quarterly:**
- Conduct HIPAA compliance audit
- Review and update PHI sanitization rules
- Update Matomo to latest version

### Performance Optimization

**Client-Side:**
- Analytics tracking is asynchronous (doesn't block page load)
- Matomo script loads after page content
- Use event batching for high-traffic pages

**Server-Side:**
- Tracking requests have 5-second timeout
- Failures don't break app functionality (logged but not thrown)
- Consider using a queue for high-volume tracking

### Security Best Practices

1. **Protect Matomo admin panel:**
   - Enable 2FA for all admin accounts
   - Use IP whitelisting
   - Strong passwords (min 16 characters)

2. **Secure API tokens:**
   - Store in environment variables only
   - Never commit to version control
   - Rotate tokens quarterly

3. **Monitor access logs:**
   - Enable Matomo activity log plugin
   - Review admin actions monthly
   - Alert on suspicious activity

---

## Troubleshooting

### Common Issues

**Issue: No tracking data appearing**
- **Solution**: Check environment variables are set correctly
- Verify Matomo URL is accessible
- Check browser console for JavaScript errors

**Issue: Server-side tracking not working**
- **Solution**: Verify `MATOMO_AUTH_TOKEN` is correct
- Check server logs for error messages
- Test API directly with curl command

**Issue: Visitor-to-user linking not working**
- **Solution**: Ensure `setUserId()` is called after login/signup
- Verify same cookie domain for client and server
- Check that user IDs are consistent

**Issue: PHI appearing in reports**
- **Solution**: Review sanitization functions
- Update exclusion rules in Matomo
- Add additional regex patterns to sanitizers

### Getting Help

- **Matomo Documentation**: https://matomo.org/docs/
- **Matomo Forums**: https://forum.matomo.org/
- **HIPAA Compliance Guide**: https://matomo.org/blog/2018/04/how-matomo-helps-you-achieve-gdpr-compliance/
- **TherapyConnect Issues**: [Internal support channel]

---

## Summary

You now have a complete Matomo analytics implementation that:

✅ Tracks **anonymous visitors** before they sign up
✅ Tracks **authenticated users** after login
✅ Links anonymous visitor sessions to user accounts
✅ Maintains HIPAA compliance with PHI protection
✅ Provides actionable insights for growth and engagement

**Key Files Created:**
- `client/src/services/analytics.ts` - Client-side tracking
- `server/services/matomoAnalytics.ts` - Server-side tracking
- `server/middleware/analyticsMiddleware.ts` - Automatic tracking helpers

**Key Metrics to Monitor:**
1. Unique Visitors (anonymous users browsing)
2. Unique Users (registered users)
3. Visitor-to-User Conversion Rate
4. User Activation Rate (profile completion)
5. Engagement Metrics (searches, matches, appointments)

**Next Steps:**
1. Install and configure Matomo server
2. Set up environment variables
3. Test tracking in development
4. Deploy to production
5. Create dashboards and reports in Matomo
6. Monitor metrics weekly

---

## Appendix: Environment Variables

```bash
# Client-side (anonymous visitors)
VITE_MATOMO_URL=https://analytics.yourdomain.com
VITE_MATOMO_SITE_ID=1

# Server-side (authenticated users)
MATOMO_URL=https://analytics.yourdomain.com
MATOMO_SITE_ID=2
MATOMO_AUTH_TOKEN=32_character_auth_token_from_matomo
```

## Appendix: Matomo Site Configuration

**Site 1: Anonymous Visitors**
- Name: TherapyConnect - Anonymous
- URL: https://therapyconnect.com
- Timezone: Your local timezone
- Currency: USD
- Ecommerce: Disabled
- Site search: Enabled

**Site 2: Authenticated Users**
- Name: TherapyConnect - Authenticated
- URL: https://app.therapyconnect.com
- Timezone: Your local timezone
- Currency: USD
- Ecommerce: Disabled (or enabled if you track revenue)
- Site search: Disabled (use custom events instead)

---

**Document Version**: 1.0
**Last Updated**: 2025-10-20
**Author**: TherapyConnect Development Team
